# Allows HTTP traffic to communicate with the operator within the local cluster network

apiVersion: projectcalico.org/v3
kind: NetworkPolicy
metadata:
  name: postgres-operator-ingress
  namespace: postgres-operator
spec:
  selector: app.kubernetes.io/instance == 'postgres-operator'
  types:
    - Ingress
    - Egress
  ingress:
    # Allow all cluster namespaces to communciate with the operator to create/get resources (needed for the main postgres-operator service)
    - action: Allow
      metadata:
        annotations:
          from: all-namespaces
          to: postgres-operator
      protocol: TCP
      source:
        namespaceSelector: has(projectcalico.org/name)
      destination:
        ports:
          - 8080
  egress:
    - action: Allow
---
apiVersion: projectcalico.org/v3
kind: NetworkPolicy
metadata:
  name: postgres-operator-ui-ingress
  namespace: postgres-operator
spec:
  selector: app.kubernetes.io/instance == 'postgres-operator-ui'
  types:
    - Ingress
    - Egress
  ingress:
    # Allow UI traffic coming in from the Nginx ingress controller
    - action: Allow
      metadata:
        annotations:
          from: ingress-nginx
          to: postgres-operator-ui
      protocol: TCP
      source:
        namespaceSelector: projectcalico.org/name == 'ingress-nginx'
      destination:
        ports:
          - 80
          - 443
          - 8081
  egress:
    - action: Allow